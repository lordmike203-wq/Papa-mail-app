<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Private Mailbox</title>
    
    <!-- PWA & Mobile App Settings -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Private Mail">
    
    <!-- Link to the manifest file -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icon (Inlined SVG) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiI+PGNpcmNsZSBjeD0iMjU2IiBjeT0iMjU2IiByPSIyNTYiIGZpbGw9IiM0ZjQ2ZTUwMCIvPjxwYXRoIGZpbGw9IiNmZmYiIGQ9Ik00NjQgNjRINDRDMTcuNSA2NCAwIDgxLjUgMCAxMDh2Mjg4YzAgMjYuNSAxNy41IDQ4IDQ0IDQ4aDQyNGMyNi41IDAgNDQtMjEuNSA0NC00OFYxMDhjMC0yNi41LTE3LjUtNDQtNDQtNDR6bS0xMS43IDEwMS40bC0xODAgMTQ0Yy0xMC40IDguMy0yNS4yIDguMy0zNS42IDBsLTE4MC0xNDRjLTEwLjItOC4yLTExLjgtMjMuNC0zLjYtMzMuNnMxMS44LTIzLjQgMzMuNi0zLjZsMTgwIDE0NC4xIDE4MC0xNDQuMWMxMC4yLTguMiAyNS40LTYuNiAzMy42IDMuNnM2LjYgMjUuNC0zLjYgMzMuNnoiLz48L3N2Zz4=">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        .spinner-sm { width: 16px; height: 16px; border-width: 2px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans antialiased flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white dark:bg-gray-800 rounded-2xl shadow-xl overflow-hidden">
        
        <header class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h1 class="text-2xl font-bold text-center text-indigo-600 dark:text-indigo-400">My Private Mailbox</h1>
            <p class="text-center text-sm text-gray-500 dark:text-gray-400 mt-1">Powered by Netlify & Mailgun</p>
        </header>

        <main class="p-6">
            
            <!-- Settings Section (Collapsible) -->
            <details id="settings-details" class="mb-4 bg-gray-50 dark:bg-gray-700 rounded-lg" open>
                <summary class="p-4 cursor-pointer font-semibold text-lg flex justify-between items-center">
                    <span>Settings (Save Your Domain)</span>
                    <span class="text-sm text-indigo-500">[Click to hide]</span>
                </summary>
                <div class="p-4 border-t border-gray-200 dark:border-gray-600">
                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                        <strong>Important:</strong> Your Mailgun API Key is no longer saved here. You must save it in your Netlify site settings.
                        <br>
                        Go to: <code class="text-xs bg-gray-200 dark:bg-gray-800 p-1 rounded">Site settings -> Build & deploy -> Environment -> Environment variables</code>.
                        <br>
                        Create two variables:
                        <br>1. <code class="text-xs bg-gray-200 dark:bg-gray-800 p-1 rounded">MAILGUN_API_KEY</code> (value: your <code class="text-xs">key-...</code>)
                        <br>2. <code class="text-xs bg-gray-200 dark:bg-gray-800 p-1 rounded">MAILGUN_API_REGION</code> (value: <code class="text-xs">api.mailgun.net</code> or <code class="text-xs">api.eu.mailgun.net</code>)
                    </p>
                    <div class="mb-4">
                        <label for="domain" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Mailgun Sandbox Domain:</label>
                        <input id="domain" type="text" class="w-full p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600" placeholder="sandbox-....mailgun.org">
                    </div>
                    <button id="save-settings" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200">
                        Save Domain
                    </button>
                </div>
            </details>

            <!-- Status Message Area -->
            <div id="status-message" class="hidden text-sm p-3 rounded-lg my-4 text-center"></div>

            <!-- Email Address Section -->
            <div id="email-section" class="mb-6 hidden">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Your Private Email Address:</label>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input id="email-prefix" type="text" class="w-full sm:w-1/2 p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-300 dark:border-gray-600" placeholder="your-prefix">
                    <span class="p-3 text-gray-500 dark:text-gray-400">@</span>
                    <input id="email-domain" type="text" readonly class="w-full sm:flex-grow p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:outline-none">
                </div>
                <button id="copy-email" class="mt-3 w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-200">
                    <span id="copy-text">Copy Full Email</span>
                </button>
            </div>

            <!-- Inbox Section -->
            <div id="inbox-view" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Inbox</h2>
                    <button id="refresh-inbox-btn" class="flex items-center justify-center gap-2 px-4 py-2 bg-blue-500 text-white font-medium rounded-lg hover:bg-blue-600 transition duration-200" title="Refresh Inbox">
                        <span id="refresh-text">Refresh</span>
                        <div id="inbox-loader" class="hidden">
                            <div class="spinner spinner-sm border-left-color-white"></div>
                        </div>
                    </button>
                </div>
                <div id="inbox-container" class="h-64 overflow-y-auto bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-3">
                    <p id="inbox-placeholder" class="text-gray-500 dark:text-gray-400 text-center mt-4">No messages yet. Click "Refresh" to check.</p>
                </div>
            </div>

            <!-- Message View Section (Hidden by default) -->
            <div id="message-view" class="hidden">
                <button id="back-to-inbox-btn" class="mb-4 flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-100 font-medium rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition duration-200">
                    Back to Inbox
                </button>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 p-4">
                    <div class="pb-3 mb-3 border-b border-gray-300 dark:border-gray-600">
                        <p class="text-sm"><strong>From:</strong> <span id="msg-from"></span></p>
                        <p class="text-sm"><strong>Subject:</strong> <span id="msg-subject"></span></p>
                        <p class="text-sm"><strong>Date:</strong> <span id="msg-date"></span></p>
                    </div>
                    <pre id="msg-body" class="w-full h-64 overflow-y-auto whitespace-pre-wrap font-sans text-sm"></pre>
                </div>
            </div>
        </main>
    </div>

    <!-- PWA Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('Service Worker registered.', reg))
                .catch(err => console.error('Service Worker registration failed.', err));
        }
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const settingsDetails = document.getElementById('settings-details');
            const domainInput = document.getElementById('domain');
            const saveSettingsBtn = document.getElementById('save-settings');
            const statusMessage = document.getElementById('status-message');
            const emailSection = document.getElementById('email-section');
            const emailPrefixInput = document.getElementById('email-prefix');
            const emailDomainInput = document.getElementById('email-domain');
            const copyEmailBtn = document.getElementById('copy-email');
            const copyText = document.getElementById('copy-text');
            const inboxView = document.getElementById('inbox-view');
            const refreshInboxBtn = document.getElementById('refresh-inbox-btn');
            const refreshText = document.getElementById('refresh-text');
            const inboxLoader = document.getElementById('inbox-loader');
            const inboxContainer = document.getElementById('inbox-container');
            const inboxPlaceholder = document.getElementById('inbox-placeholder');
            const messageView = document.getElementById('message-view');
            const backToInboxBtn = document.getElementById('back-to-inbox-btn');
            const msgFrom = document.getElementById('msg-from');
            const msgSubject = document.getElementById('msg-subject');
            const msgDate = document.getElementById('msg-date');
            const msgBody = document.getElementById('msg-body');

            // --- State ---
            let currentDomain = '';

            // --- Helper Functions ---
            function showStatusMessage(message, type = 'error') {
                statusMessage.textContent = message;
                statusMessage.classList.remove('hidden', 'bg-red-100', 'dark:bg-red-900', 'text-red-700', 'dark:text-red-200', 'bg-green-100', 'dark:bg-green-900', 'text-green-700', 'dark:text-green-200');
                if (type === 'error') {
                    statusMessage.classList.add('bg-red-100', 'dark:bg-red-900', 'text-red-700', 'dark:text-red-200');
                } else if (type === 'success') {
                    statusMessage.classList.add('bg-green-100', 'dark:bg-green-900', 'text-green-700', 'dark:text-green-200');
                }
            }
            function hideStatusMessage() { statusMessage.classList.add('hidden'); }
            function setLoadingState(loaderElement, isLoading, textElement = null) {
                if (loaderElement.tagName === 'BUTTON') { loaderElement.disabled = isLoading; }
                if (isLoading) {
                    loaderElement.classList.remove('hidden');
                    if (textElement) textElement.classList.add('hidden');
                } else {
                    loaderElement.classList.add('hidden');
                    if (textElement) textElement.classList.remove('hidden');
                }
            }

            // --- App Logic ---
            function loadSettings() {
                const savedDomain = localStorage.getItem('mailgunDomain');
                if (savedDomain) {
                    domainInput.value = savedDomain;
                    saveSettings(true); // Load silently
                }
            }

            function saveSettings(isSilentLoad = false) {
                const domain = domainInput.value.trim();
                if (!domain) {
                    if (!isSilentLoad) showStatusMessage('Please enter your Mailgun Domain.', 'error');
                    return;
                }
                currentDomain = domain;
                try {
                    localStorage.setItem('mailgunDomain', domain);
                } catch (e) {
                    console.error("Could not save to localStorage", e);
                    if (!isSilentLoad) showStatusMessage('Error: Could not save settings. Browser might be in private mode.', 'error');
                    return;
                }
                
                if (!isSilentLoad) {
                    showStatusMessage('Domain saved!', 'success');
                    setTimeout(hideStatusMessage, 2000);
                }
                emailDomainInput.value = currentDomain;
                emailSection.classList.remove('hidden');
                inboxView.classList.remove('hidden');
                settingsDetails.open = false; // Collapse settings
            }

            function copyEmail() {
                const prefix = emailPrefixInput.value.trim() || 'my-code';
                if (!currentDomain) {
                    showStatusMessage('Save your domain first!', 'error');
                    return;
                }
                const fullEmail = `${prefix}@${currentDomain}`;
                const tempInput = document.createElement('input');
                tempInput.value = fullEmail;
                document.body.appendChild(tempInput);
                tempInput.select();
                tempInput.setSelectionRange(0, 99999);
                try {
                    document.execCommand('copy');
                    copyText.textContent = 'Copied!';
                    showStatusMessage('Email copied to clipboard!', 'success');
                    setTimeout(() => {
                        copyText.textContent = 'Copy Full Email';
                        hideStatusMessage();
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    copyText.textContent = 'Failed!';
                    showStatusMessage('Failed to copy.', 'error');
                }
                document.body.removeChild(tempInput);
            }

            async function checkInbox() {
                if (!currentDomain) {
                    showStatusMessage('Domain is missing.', 'error');
                    return;
                }
                setLoadingState(inboxLoader, true, refreshText);
                hideStatusMessage();
                try {
                    const response = await fetch(`/.netlify/functions/get-mail?domain=${currentDomain}`);
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || `Server error: ${response.statusText}`);
                    }
                    const data = await response.json();
                    renderInbox(data.items || []);
                } catch (error) {
                    console.error('Error checking inbox:', error);
                    showStatusMessage(`Error: ${error.message}`, 'error');
                    inboxPlaceholder.textContent = `Error checking inbox. ${error.message}`;
                } finally {
                    setLoadingState(inboxLoader, false, refreshText);
                }
            }

            function renderInbox(messages) {
                if (messages.length === 0) {
                    inboxPlaceholder.classList.remove('hidden');
                    inboxContainer.innerHTML = '';
                    inboxContainer.appendChild(inboxPlaceholder);
                    return;
                }
                inboxPlaceholder.classList.add('hidden');
                inboxContainer.innerHTML = '';
                messages.forEach(msg => {
                    const msgElement = document.createElement('div');
                    msgElement.className = 'p-3 border-b border-gray-200 dark:border-gray-600 last:border-b-0 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer rounded-md transition-colors';
                    const from = msg.message.headers.from;
                    const subject = msg.message.headers.subject;
                    const date = new Date(msg.timestamp * 1000).toLocaleString();
                    const recipient = msg.message.headers.to;
                    msgElement.innerHTML = `
                        <p class="font-semibold truncate" title="${from}">${from}</p>
                        <p class="text-sm truncate"><strong>To:</strong> ${recipient}</p>
                        <p class="text-sm truncate">${subject}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${date}</p>
                    `;
                    msgElement.addEventListener('click', () => readMessage(msg.storage.url));
                    inboxContainer.appendChild(msgElement);
                });
            }

            async function readMessage(storageUrl) {
                showInboxView(false);
                msgFrom.textContent = 'Loading...';
                msgSubject.textContent = 'Loading...';
                msgDate.textContent = 'Loading...';
                msgBody.textContent = 'Loading message content...';
                try {
                    const response = await fetch(`/.netlify/functions/get-mail?url=${btoa(storageUrl)}`);
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error || 'Could not fetch message');
                    }
                    const message = await response.json();
                    msgFrom.textContent = message.From;
                    msgSubject.textContent = message.Subject;
                    msgDate.textContent = new Date(message.Date).toLocaleString();
                    msgBody.textContent = message['body-plain'] || 'No text content found.';
                } catch (error) {
                    console.error('Error reading message:', error);
                    msgBody.textContent = 'Error loading message.';
                }
            }

            function showInboxView(show = true) {
                if (show) {
                    messageView.classList.add('hidden');
                    inboxView.classList.remove('hidden');
                } else {
                    inboxView.classList.add('hidden');
                    messageView.classList.remove('hidden');
                }
            }

            // --- Event Listeners ---
            saveSettingsBtn.addEventListener('click', () => saveSettings(false));
            copyEmailBtn.addEventListener('click', copyEmail);
            refreshInboxBtn.addEventListener('click', checkInbox);
            backToInboxBtn.addEventListener('click', () => showInboxView(true));

            // --- Initial Load ---
            loadSettings();
        });
    </script>
</body>
</html>


